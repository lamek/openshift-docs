// Module included in the following assemblies:
//
// getting_started_moa/creating-first-moa-cluster.adoc


[id="moa-installing-prerequisites"]
= Installing prerequisites

Complete the following prerequisites before creating your {product-title} cluster.

.Procedure

. Select the AWS account you want to use.
+
Unless you are just testing out MOA, we recommend using a dedicated AWS account to run any production clusters. If you are utilizing AWS Organizations, you can use an AWS account within your organization or link:https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_accounts_create.html#orgs_manage_accounts_create-new[create a new one].
+
If you are using AWS organizations and you need to have a Service Control Policy (SCP) applied to the AWS account you plan to use, see the link:https://www.openshift.com/dedicated/ccs#scp[Red Hat Requirements for Customer Cloud Subscriptions] for details on the minimum required SCP.
+
As part of the cluster creation process, `moactl` will create an osdCcsAdmin IAM user. This user will leverage the IAM credentials you provide when configuring the AWS cli.
+
[NOTE]
====
This user will have Programmatic access enabled and the AdministratorAccess policy attached to it.
====
+
. Install and configure the AWS cli.
.. Install the link:https://aws.amazon.com/cli/[aws-cli].
.. Configure the `aws-cli` to use the AWS account that you would like to deploy your cluster into. Modify your `~/.aws/credentials` file to specify the correct `aws_access_key_id` and `aws_secret_access_key`.
+
[source, bash]
----
$ cat ~/.aws/credentials
[default]
aws_access_key_id = <my-aws-access-key-id>
aws_secret_access_key = <my-aws-secret-access-key>
----
+
.. Modify your `~/.aws/config` file to specify the AWS region you want to use.
+
[source, bash]
----
$ cat ~/.aws/config
[default]
output = table
region = us-east-2
----
+
.. To verify your configuration, run the following command to query the AWS api:
+
[source, bash]
----
$ aws ec2 describe-regions
---------------------------------------------------------------------------------
|                                DescribeRegions                                |
+-------------------------------------------------------------------------------+
||                                   Regions                                   ||
|+-----------------------------------+-----------------------+-----------------+|
||             Endpoint              |      OptInStatus      |   RegionName    ||
|+-----------------------------------+-----------------------+-----------------+|
||  ec2.eu-north-1.amazonaws.com     |  opt-in-not-required  |  eu-north-1     ||
||  ec2.ap-south-1.amazonaws.com     |  opt-in-not-required  |  ap-south-1     ||
||  ec2.eu-west-3.amazonaws.com      |  opt-in-not-required  |  eu-west-3      ||
||  ec2.eu-west-2.amazonaws.com      |  opt-in-not-required  |  eu-west-2      ||
||  ec2.eu-west-1.amazonaws.com      |  opt-in-not-required  |  eu-west-1      ||
||  ec2.ap-northeast-2.amazonaws.com |  opt-in-not-required  |  ap-northeast-2 ||
||  ec2.ap-northeast-1.amazonaws.com |  opt-in-not-required  |  ap-northeast-1 ||
||  ec2.sa-east-1.amazonaws.com      |  opt-in-not-required  |  sa-east-1      ||
||  ec2.ca-central-1.amazonaws.com   |  opt-in-not-required  |  ca-central-1   ||
||  ec2.ap-southeast-1.amazonaws.com |  opt-in-not-required  |  ap-southeast-1 ||
||  ec2.ap-southeast-2.amazonaws.com |  opt-in-not-required  |  ap-southeast-2 ||
||  ec2.eu-central-1.amazonaws.com   |  opt-in-not-required  |  eu-central-1   ||
||  ec2.us-east-1.amazonaws.com      |  opt-in-not-required  |  us-east-1      ||
||  ec2.us-east-2.amazonaws.com      |  opt-in-not-required  |  us-east-2      ||
||  ec2.us-west-1.amazonaws.com      |  opt-in-not-required  |  us-west-1      ||
||  ec2.us-west-2.amazonaws.com      |  opt-in-not-required  |  us-west-2      ||
|+-----------------------------------+-----------------------+-----------------+|
----
+
. Install `moactl`, the {product-title} command line utility.
.. Download the link:https://github.com/openshift/moactl/releases/latest[latest release of moactl] and add it to your path.
.. Verify your installation by running the following command:
+
[source, bash]
----
$ moactl
Command line tool for MOA.

Usage:
  moactl [command]

Available Commands:
  completion  Generates bash completion scripts
  create      Create a resource from stdin
  delete      Delete a specific resource
  describe    Show details of a specific resource
  edit        Edit a specific resource
  help        Help about any command
  init        Applies templates to support Managed OpenShift on AWS clusters
  list        List all resources of a specific type
  login       Log in to your Red Hat account
  logout      Log out
  logs        Show logs of a specific resource
  verify      Verify resources are configured correctly for cluster install
  version     Prints the version of the tool

Flags:
      --debug     Enable debug mode.
  -h, --help      help for moactl
  -v, --v Level   log level for V logs

Use "moactl [command] --help" for more information about a command.
----
+
.. (Optional) You can run `moactl completion` to generate a bash completion file. Add this file to the correct location for your operating system. For example, on a Linux machine run the following command to enable moactl bash completion:
+
[source, bash]
----
moactl completion > /etc/bash_completion.d/moactl
source /etc/bash_completion.d/moactl
----
+
. Run the following command to verify that your AWS account has the necessary permissions:
+
[source,bash]
----
$ moactl verify permissions
I: Validating SCP policies...
I: AWS SCP policies ok
----
+
.. Verify that your AWS account has the necessary quota to deploy an OpenShift cluster.
+
[source,bash]
----
$ export AWS_DEFAULT_REGION=us-west-2 && moactl verify quota
I: Validating AWS quota...
E: Insufficient AWS quotas
E: Service ebs quota code L-FD252861 Provisioned IOPS SSD (io1) volume storage not valid
----
+
[NOTE]
====
Sometimes quota varies by region, which may prevent you from deploying. If you receive any errors, try a different region.
====
+
If you need to increase your quota, navigate to your link:https://aws.amazon.com/console/[AWS console], and request a quota increase for the service that failed.
+
Once both the permissions and quota checks pass, proceed to initializing your AWS account.
+
. Prepare your AWS account for cluster deployment
+
.. Run the following command to log in to your Red Hat account with moactl. Replace `<my-offline-access-token>` with your token:
+
[NOTE]
====
If you do not already have a Red Hat account, link:https://cloud.redhat.com/[create one here]. Be sure to accept the required terms and conditions. Then, check your email for a verification link.  

After creating your Red Hat account, follow this link to link:https://cloud.redhat.com/openshift/token/moa[get an offline access token].
====
+
[source, bash]
----
$ moactl login --token="<my-offline-access-token>"
----
+
.. Run the following command to verify your Red Hat and AWS credentials are setup correctly.  Check that your AWS Account ID, Default Region and ARN match what you expect.  You can safely ignore the rows beginning with OCM for now (OCM stands for OpenShift Cluster Manager).
+
[source, bash]
----
$ moactl whoami
AWS Account ID:               000000000000
AWS Default Region:           us-east-2
AWS ARN:                      arn:aws:iam::000000000000:user/hello
OCM API:                      https://api.openshift.com
OCM Account ID:               1DzGIdIhqEWyt8UUXQhSoWaaaaa
OCM Account Name:             Your Name
OCM Account Username:         you@domain.com
OCM Account Email:            you@domain.com
OCM Organization ID:          1HopHfA2hcmhup5gCr2uH5aaaaa
OCM Organization Name:        Red Hat
OCM Organization External ID: 0000000
----
+
.. Initialize your AWS account. This step runs a CloudFormation template that prepares your AWS account for OpenShift deployment and management. This step typically takes 1-2 minutes to complete.
+
[source, bash]
----
$ moactl init
I: Logged in as 'rh-moa-user' on 'https://api.openshift.com'
I: Validating AWS credentials...
I: AWS credentials are valid!
I: Validating SCP policies...
I: AWS SCP policies ok
I: Validating AWS quota...
I: AWS quota ok
I: Ensuring cluster administrator user 'osdCcsAdmin'...
I: Admin user 'osdCcsAdmin' created successfuly!
I: Verifying whether OpenShift command-line tool is available...
E: OpenShift command-line tool is not installed.
Go to https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/ to download the OpenShift client and add it to your PATH.
----
+
[NOTE]
====
If you have not already installed the OpenShift Command Line Utility, also known as `oc`, follow the link in the output to install it now.
====

After completing these steps you are ready to create an {product-title} cluster.
